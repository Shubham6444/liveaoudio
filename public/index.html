<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Voice Chat Room</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #4f46e5;
      --primary-hover: #4338ca;
      --secondary-color: #6366f1;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --dark-bg: #0f172a;
      --dark-surface: #1e293b;
      --dark-card: #334155;
      --dark-text: #f1f5f9;
      --dark-text-secondary: #94a3b8;
      --light-bg: #f8fafc;
      --light-surface: #ffffff;
      --light-card: #f1f5f9;
      --light-text: #1e293b;
      --light-text-secondary: #64748b;
      --border-radius: 12px;
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    [data-theme="dark"] {
      --bg-color: var(--dark-bg);
      --surface-color: var(--dark-surface);
      --card-color: var(--dark-card);
      --text-color: var(--dark-text);
      --text-secondary: var(--dark-text-secondary);
      --border-color: #475569;
    }

    [data-theme="light"] {
      --bg-color: var(--light-bg);
      --surface-color: var(--light-surface);
      --card-color: var(--light-card);
      --text-color: var(--light-text);
      --text-secondary: var(--light-text-secondary);
      --border-color: #e2e8f0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-color);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-color);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      line-height: 1.6;
    }

    /* Enhanced join form with professional styling */
    .join-form {
      background: var(--surface-color);
      padding: 2.5rem;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      text-align: center;
      min-width: 320px;
      width: 90vw;
      max-width: 420px;
      border: 1px solid var(--border-color);
    }

    .join-form h1 {
      margin-bottom: 2rem;
      color: var(--text-color);
      font-size: 1.875rem;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    .join-form input {
      width: 100%;
      padding: 0.875rem 1rem;
      margin: 0.75rem 0;
      border: 2px solid var(--border-color);
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--surface-color);
      color: var(--text-color);
      font-weight: 500;
    }

    .join-form input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }

    .join-form button {
      width: 100%;
      padding: 0.875rem 1rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      margin-top: 0.5rem;
    }

    .join-form button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    /* Professional full-screen chat interface */
    .chat-interface {
      background: var(--surface-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    /* Modern header with professional styling */
    .header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 1rem;
      box-shadow: var(--shadow);
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    /* Professional YouTube button with proper icon */
    .youtube-btn {
      background: #ff0000;
      color: white;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 20px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 600;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .youtube-btn:hover {
      background: #cc0000;
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    /* Professional theme toggle with SVG icon */
    .theme-toggle {
      background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.2);
      color: white;
      padding: 0.5rem;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.125rem;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
    }

    .theme-toggle:hover {
      background: rgba(255,255,255,0.25);
      transform: scale(1.05);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      font-weight: 500;
    }

    .admin-badge {
      background: var(--danger-color);
      padding: 0.25rem 0.5rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    /* Enhanced admin panel with professional styling */
    .admin-panel {
      background: var(--card-color);
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .admin-panel h3 {
      margin-bottom: 0.75rem;
      color: var(--text-color);
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .admin-actions {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .admin-btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.875rem;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.375rem;
    }

    .mute-all { 
      background: var(--warning-color); 
      color: white; 
    }
    .unmute-all { 
      background: var(--success-color); 
      color: white; 
    }
    .admin-btn:hover { 
      transform: translateY(-1px); 
      box-shadow: var(--shadow);
    }

    /* Professional voice controls with proper icons */
    .voice-controls {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      padding: 1.5rem;
      background: var(--card-color);
      border-bottom: 1px solid var(--border-color);
      flex-wrap: wrap;
    }

    .voice-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      min-width: 80px;
      color: var(--text-color);
      font-weight: 500;
    }

    .voice-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .voice-btn.muted {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .voice-btn.leave {
      background: var(--danger-color);
      color: white;
      border-color: var(--danger-color);
    }

    .voice-btn.leave:hover {
      background: #dc2626;
    }

    /* Enhanced participants section */
    .participants {
      flex: 1;
      padding: 1.5rem;
      overflow-y: auto;
      background: var(--bg-color);
    }

    .participants h3 {
      margin-bottom: 1rem;
      color: var(--text-color);
      font-size: 1.125rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .participant {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      margin: 0.75rem 0;
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
    }

    .participant:hover {
      border-color: var(--primary-color);
      transform: translateY(-1px);
    }

    .participant.speaking {
      border-left: 4px solid var(--success-color);
      background: rgba(16, 185, 129, 0.05);
      box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.1);
    }

    .participant.muted {
      opacity: 0.6;
    }

    .participant-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .participant-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.125rem;
      box-shadow: var(--shadow);
    }

    .participant-details {
      display: flex;
      flex-direction: column;
      gap: 0.125rem;
    }

    .participant-name {
      font-weight: 600;
      color: var(--text-color);
      font-size: 0.875rem;
    }

    .participant-status {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .participant-controls {
      display: flex;
      gap: 0.5rem;
    }

    .control-btn {
      padding: 0.375rem 0.75rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 0.25rem;
    }

    .mute-btn { 
      background: var(--warning-color); 
      color: white; 
    }
    .remove-btn { 
      background: var(--danger-color); 
      color: white; 
    }
    .control-btn:hover { 
      transform: scale(1.05); 
      box-shadow: var(--shadow);
    }

    .hidden { display: none !important; }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-secondary);
      margin-left: 0.5rem;
    }

    .status-indicator.speaking { 
      background: var(--success-color); 
      animation: pulse 1.5s ease-in-out infinite; 
    }
    .status-indicator.muted { 
      background: var(--danger-color); 
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Enhanced mobile responsiveness */
    @media (max-width: 768px) {
      .chat-interface {
        border-radius: 0;
      }
      
      .header {
        padding: 1rem;
        flex-direction: column;
        gap: 0.75rem;
      }
      
      .header-left, .header-right {
        justify-content: center;
      }
      
      .voice-controls {
        gap: 1rem;
        padding: 1rem;
      }
      
      .voice-btn {
        min-width: 70px;
        padding: 0.875rem 0.75rem;
        font-size: 0.875rem;
      }
      
      .admin-actions {
        justify-content: center;
      }
      
      .participant {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
      }
      
      .participant-controls {
        align-self: flex-end;
      }
    }

    @media (max-width: 480px) {
      .voice-btn {
        min-width: 60px;
        padding: 0.75rem 0.5rem;
        font-size: 0.8rem;
      }
      
      .participants {
        padding: 1rem;
      }
    }
  </style>
</head>
<body data-theme="light">
  <!-- Join Form -->
  <div id="joinForm" class="join-form">
    <h1>Join Voice Chat</h1>
    <input type="text" id="usernameInput" placeholder="Enter your name" maxlength="20" required>
    <input type="text" id="roomInput" placeholder="Room ID" maxlength="20" required>
    <button onclick="joinRoom()">Join Room</button>
  </div>

  <!-- Chat Interface -->
  <div id="chatInterface" class="chat-interface hidden">
    <div class="header">
      <div class="header-left">
        <h2 id="roomTitle">Voice Chat Room</h2>
        <!-- Professional YouTube button with SVG icon -->
        <a href="https://youtube.com/@yourchannel" target="_blank" class="youtube-btn">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
          </svg>
          Subscribe
        </a>
      </div>
      <div class="header-right">
        <!-- Professional theme toggle with SVG icons -->
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
          <svg id="themeIcon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
          </svg>
        </button>
        <div style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
            <path d="M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63A1.5 1.5 0,0,0 18.54 8H17c-.8 0-1.54.37-2.01.99l-2.98 3.67a.5.5 0 0 0 .39.84H14v8h6zm-12.5 0v-7.5h-2A1.5 1.5 0 0 1 4 13V9.5A1.5 1.5 0 0 1 5.5 8h3A1.5 1.5 0 0 1 10 9.5V13a1.5 1.5 0 0 1-1.5 1.5h-2V22h-3z"/>
          </svg>
          <span id="participantCount">0</span>
        </div>
      </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="admin-panel hidden">
      <h3>
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,1L3,5V11C3,16.55 6.84,21.74 12,23C17.16,21.74 21,16.55 21,11V5L12,1M12,7C13.4,7 14.8,8.6 14.8,10V11.5C14.8,12.6 14.4,13.5 13.5,13.5H10.5C9.6,13.5 9.2,12.6 9.2,11.5V10C9.2,8.6 10.6,7 12,7Z"/>
        </svg>
        Admin Controls
      </h3>
      <div class="admin-actions">
        <button class="admin-btn mute-all" onclick="muteAllUsers()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3,9H7L12,4V20L7,15H3V9M16,15H18V9H16V15Z"/>
          </svg>
          Mute All
        </button>
        <button class="admin-btn unmute-all" onclick="unmuteAllUsers()">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
            <path d="M3,9H7L12,4V20L7,15H3V9M16,15H18V9H16V15Z"/>
          </svg>
          Unmute All
        </button>
      </div>
    </div>

    <!-- Professional voice controls with SVG icons -->
    <div class="voice-controls">
      <div id="muteBtn" class="voice-btn" onclick="toggleMute()">
        <svg id="muteIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
        </svg>
        <span id="muteText">Mute</span>
      </div>
      <div id="speakerBtn" class="voice-btn" onclick="toggleSpeaker()">
        <svg id="speakerIcon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/>
        </svg>
        <span id="speakerText">Speaker</span>
      </div>
      <div class="voice-btn leave" onclick="leaveRoom()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12,9A3,3 0 0,0 9,12A3,3 0 0,0 12,15A3,3 0 0,0 15,12A3,3 0 0,0 12,9M12,17A5,5 0 0,1 7,12A5,5 0 0,1 12,7A5,5 0 0,1 17,12A5,5 0 0,1 12,17M12,4.5C7,4.5 2.73,7.61 1,12C2.73,16.39 7,19.5 12,19.5C17,19.5 21.27,16.39 23,12C21.27,7.61 17,4.5 12,4.5Z"/>
        </svg>
        <span>Leave</span>
      </div>
    </div>

    <!-- Participants -->
    <div class="participants">
      <h3>
        <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
          <path d="M16,4C16.88,4 17.67,4.5 18,5.26L20,9H16V11H20.5L19,14H16V16H18.5L17,19H15L17,16H14V14H17.5L19,11H16V9H19.5L18,6H16V4M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,0 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
        </svg>
        Participants
      </h3>
      <div id="participantsList"></div>
    </div>
  </div>

  <!-- Added audio elements for sound effects -->
  <audio id="muteSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIG2m98OScTgwOUarm7blmGgU7k9n1unEiBC13yO/eizEIHWq+8+OWT" type="audio/wav">
  </audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>

    const socket = io();
    let localStream = null;
    let peerConnections = {};
    let isMuted = false;
    let isSpeakerMuted = false;
    let isAdmin = false;
    let currentUser = null;
    let currentRoom = null;

    const rtcConfig = {
      iceServers: [
        { urls: 'stun:stun.l.google.com:19302' },
        { urls: 'stun:stun1.l.google.com:19302' },
        { urls: 'stun:stun2.l.google.com:19302' },
        { urls: 'stun:stun3.l.google.com:19302' }
      ]
    };

    function toggleTheme() {
      const body = document.body;
      const themeIcon = document.getElementById('themeIcon');
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      
      body.setAttribute('data-theme', newTheme);
      
      if (newTheme === 'dark') {
        themeIcon.innerHTML = '<path d="M12,18C11.11,18 10.26,17.8 9.5,17.45C11.56,16.5 13,14.42 13,12C13,9.58 11.56,7.5 9.5,6.55C10.26,6.2 11.11,6 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31L23.31,12L20,8.69Z"/>';
      } else {
        themeIcon.innerHTML = '<path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>';
      }
      
      localStorage.setItem('theme', newTheme);
      playSound('click');
    }

    function loadTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.body.setAttribute('data-theme', savedTheme);
      const themeIcon = document.getElementById('themeIcon');
      if (themeIcon) {
        if (savedTheme === 'dark') {
          themeIcon.innerHTML = '<path d="M12,18C11.11,18 10.26,17.8 9.5,17.45C11.56,16.5 13,14.42 13,12C13,9.58 11.56,7.5 9.5,6.55C10.26,6.2 11.11,6 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31L23.31,12L20,8.69Z"/>';
        } else {
          themeIcon.innerHTML = '<path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>';
        }
      }
    }

    function playSound(type) {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }

        let frequency, duration;
        switch(type) {
          case 'mute':
            frequency = 800;
            duration = 200;
            break;
          case 'unmute':
            frequency = 1000;
            duration = 200;
            break;
          case 'join':
            frequency = 600;
            duration = 300;
            break;
          case 'leave':
            frequency = 400;
            duration = 400;
            break;
          case 'click':
            frequency = 1200;
            duration = 100;
            break;
          default:
            return;
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + duration / 1000);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration / 1000);
      } catch (error) {
        console.log('[v0] Sound effect error:', error);
      }
    }

    function joinRoom() {
      const username = document.getElementById('usernameInput').value.trim();
      const room = document.getElementById('roomInput').value.trim();
      
      if (!username || !room) {
        alert('Please enter both username and room name');
        return;
      }

      currentUser = username;
      currentRoom = room;
      
      console.log('[v0] Attempting to join room:', room, 'as:', username);
      
      socket.emit('join-room', { username: username, room });
      setupSocketListeners();
      
      navigator.mediaDevices.getUserMedia({ 
        audio: {
          echoCancellation: true,
          noiseSuppression: true,
          autoGainControl: true
        }
      })
        .then(stream => {
          console.log('[v0] Got local stream:', stream);
          localStream = stream;
          
          stream.getAudioTracks().forEach(track => {
            console.log('[v0] Audio track:', track.label, 'enabled:', track.enabled);
            track.enabled = true;
          });
          
          playSound('join');
        })
        .catch(err => {
          console.error('[v0] Error accessing microphone:', err);
          alert('Please allow microphone access to join the voice chat. Check your browser permissions.');
        });
    }

    function setupSocketListeners() {
      socket.on('room-joined', ({ isAdmin: adminStatus, participants: roomParticipants }) => {
        console.log('[v0] Room joined, isAdmin:', adminStatus, 'participants:', roomParticipants);
        isAdmin = adminStatus;
        
        document.getElementById('joinForm').classList.add('hidden');
        document.getElementById('chatInterface').classList.remove('hidden');
        document.getElementById('roomTitle').textContent = `Voice Chat Room - ${currentRoom}`;
        
        if (isAdmin) {
          document.getElementById('adminPanel').classList.remove('hidden');
        }
        
        updateParticipants(roomParticipants);
        loadTheme();
      });

      socket.on('user-joined', (participant) => {
        console.log('[v0] User joined:', participant);
        // Create peer connection for new user
        if (participant.socketId !== socket.id) {
          createPeerConnection(participant.socketId, true); // Existing users initiate
        }
        playSound('join');
      });

      socket.on('user-left', ({ socketId }) => {
        console.log('[v0] User left:', socketId);
        const peerConnection = peerConnections[socketId];
        if (peerConnection) {
          peerConnection.close();
          delete peerConnections[socketId];
        }
        
        // Remove audio element
        const audioElement = document.getElementById(`audio-${socketId}`);
        if (audioElement) {
          audioElement.remove();
        }
        
        playSound('leave');
      });

      socket.on('participants-updated', (participants) => {
        console.log('[v0] Participants updated:', participants);
        updateParticipants(participants);
      });

      socket.on('user-muted', ({ socketId, isMuted }) => {
        console.log('[v0] User muted:', socketId, isMuted);
        const participantDiv = document.getElementById(`participant-${socketId}`);
        if (participantDiv) {
          participantDiv.classList.toggle('muted', isMuted);
        }
      });

      socket.on('force-mute', () => {
        console.log('[v0] Force muted by admin');
        isMuted = true;
        toggleMute();
      });

      socket.on('force-unmute', () => {
        console.log('[v0] Force unmuted by admin');
        isMuted = false;
        toggleMute();
      });

      socket.on('user-removed', () => {
        alert('You have been removed from the room by an admin');
        leaveRoom();
      });

      socket.on('promoted-to-admin', () => {
        isAdmin = true;
        document.getElementById('adminPanel').classList.remove('hidden');
      });

      socket.on('offer', async (socketId, description) => {
        console.log('[v0] Received offer from:', socketId);
        try {
          if (!peerConnections[socketId]) {
            await createPeerConnection(socketId, false); // false means this user responds
          }
          
          const peerConnection = peerConnections[socketId];
          await peerConnection.setRemoteDescription(description);

          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);

          socket.emit('answer', socketId, answer);
          console.log('[v0] Sent answer to:', socketId);
        } catch (e) {
          console.error('[v0] Error handling offer:', e);
        }
      });

      socket.on('answer', async (socketId, description) => {
        console.log('[v0] Received answer from:', socketId);
        try {
          const peerConnection = peerConnections[socketId];
          if (peerConnection) {
            await peerConnection.setRemoteDescription(description);
            console.log('[v0] Set remote description for:', socketId);
          }
        } catch (e) {
          console.error('[v0] Error handling answer:', e);
        }
      });

      socket.on('candidate', async (socketId, candidate) => {
        try {
          const peerConnection = peerConnections[socketId];
          if (peerConnection && candidate) {
            await peerConnection.addIceCandidate(candidate);
            console.log('[v0] Added ICE candidate for:', socketId);
          }
        } catch (e) {
          console.error('[v0] Error adding ICE candidate:', e);
        }
      });

      socket.on('existing-participants', async (existingParticipants) => {
        console.log('[v0] Connecting to existing participants:', existingParticipants);
        
        // Wait a bit for local stream to be ready
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        for (const participant of existingParticipants) {
          const socketId = participant.socketId;
          if (socketId && socketId !== socket.id) {
            console.log('[v0] Creating connection to existing participant:', socketId);
            await createPeerConnection(socketId, true); // New user initiates to existing users
          }
        }
      });
    }

    async function createPeerConnection(socketId, isInitiator) {
      console.log('[v0] Creating peer connection with:', socketId, 'isInitiator:', isInitiator);
      
      // Don't create duplicate connections
      if (peerConnections[socketId]) {
        console.log('[v0] Peer connection already exists for:', socketId);
        return peerConnections[socketId];
      }
      
      const peerConnection = new RTCPeerConnection(rtcConfig);
      peerConnections[socketId] = peerConnection;

      // Handle ICE candidates
      peerConnection.onicecandidate = event => {
        if (event.candidate) {
          console.log('[v0] Sending ICE candidate to:', socketId);
          socket.emit('candidate', socketId, event.candidate);
        }
      };

      // Handle remote stream
      peerConnection.ontrack = event => {
        console.log('[v0] Received remote stream from:', socketId, 'tracks:', event.streams[0].getTracks().length);
        const remoteStream = event.streams[0];
        
        // Ensure we have audio tracks
        const audioTracks = remoteStream.getAudioTracks();
        if (audioTracks.length > 0) {
          console.log('[v0] Remote audio track enabled:', audioTracks[0].enabled);
          playRemoteAudio(socketId, remoteStream);
        }
      };

      // Handle connection state changes
      peerConnection.onconnectionstatechange = () => {
        console.log('[v0] Connection state with', socketId, ':', peerConnection.connectionState);
        if (peerConnection.connectionState === 'connected') {
          console.log('[v0] Successfully connected to:', socketId);
        } else if (peerConnection.connectionState === 'failed') {
          console.log('[v0] Connection failed with:', socketId);
          // Clean up failed connection
          delete peerConnections[socketId];
        }
      };

      // Add local stream tracks if available
      if (localStream) {
        localStream.getTracks().forEach(track => {
          console.log('[v0] Adding local track to peer connection:', track.kind, 'enabled:', track.enabled);
          peerConnection.addTrack(track, localStream);
        });
      } else {
        console.warn('[v0] No local stream available when creating peer connection');
      }

      // If this user should initiate, create and send offer
      if (isInitiator) {
        try {
          console.log('[v0] Creating offer for:', socketId);
          const offer = await peerConnection.createOffer({
            offerToReceiveAudio: true,
            offerToReceiveVideo: false
          });
          await peerConnection.setLocalDescription(offer);
          socket.emit('offer', socketId, offer);
          console.log('[v0] Sent offer to:', socketId);
        } catch (e) {
          console.error('[v0] Error creating offer for:', socketId, e);
        }
      }

      return peerConnection;
    }

    function playRemoteAudio(socketId, stream) {
      console.log('[v0] Setting up remote audio for:', socketId);
      
      // Remove existing audio element if it exists
      let audioElement = document.getElementById(`audio-${socketId}`);
      if (audioElement) {
        audioElement.remove();
      }
      
      // Create new audio element
      audioElement = document.createElement('audio');
      audioElement.id = `audio-${socketId}`;
      audioElement.autoplay = true;
      audioElement.playsInline = true;
      audioElement.controls = false;
      audioElement.volume = 1.0;
      audioElement.muted = isSpeakerMuted;
      document.body.appendChild(audioElement);
      
      // Set up event handlers
      audioElement.onloadedmetadata = () => {
        console.log('[v0] Audio metadata loaded for:', socketId);
      };
      
      audioElement.onplay = () => {
        console.log('[v0] Audio started playing for:', socketId);
      };
      
      audioElement.onerror = (e) => {
        console.error('[v0] Audio error for:', socketId, e);
      };
      
      audioElement.oncanplay = () => {
        console.log('[v0] Audio can play for:', socketId);
      };
      
      // Set the stream and play
      audioElement.srcObject = stream;
      
      // Ensure audio plays
      audioElement.play().then(() => {
        console.log('[v0] Successfully started playing audio for:', socketId);
      }).catch(e => {
        console.error('[v0] Error playing audio for:', socketId, e);
        // Try to play again after user interaction
        document.addEventListener('click', () => {
          audioElement.play().catch(console.error);
        }, { once: true });
      });
    }

    function renderParticipant(participant) {
      const participantDiv = document.createElement('div');
      participantDiv.className = `participant ${participant.isMuted ? 'muted' : ''} ${participant.isSpeaking ? 'speaking' : ''}`;
      participantDiv.id = `participant-${participant.socketId}`;

      const adminControls = isAdmin && participant.socketId !== socket.id ? `
        <div class="participant-controls">
          <button class="control-btn mute-btn" onclick="adminMuteUser('${participant.socketId}')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M3,9H7L12,4V20L7,15H3V9M16.59,12L14,9.41L15.41,8L18,10.59L20.59,8L22,9.41L19.41,12L22,14.59L20.59,16L18,13.41L15.41,16L14,14.59L16.59,12Z"/>
            </svg>
            ${participant.isMuted ? 'Unmute' : 'Mute'}
          </button>
          <button class="control-btn remove-btn" onclick="adminRemoveUser('${participant.socketId}')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19,6.41L17.59,5L12,10.59L6.41,5L5,6.41L10.59,12L5,17.59L6.41,19L12,13.41L17.59,19L19,17.59L13.41,12L19,6.41Z"/>
            </svg>
            Remove
          </button>
        </div>
      ` : '';

      const userName = participant.username || participant.name || `User${participant.socketId.slice(-4)}`;
      
      participantDiv.innerHTML = `
        <div class="participant-info">
          <div class="participant-avatar">${userName.charAt(0).toUpperCase()}</div>
          <div class="participant-details">
            <div class="participant-name">
              ${userName}
              ${participant.isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
            </div>
            <div class="participant-status">
              ${participant.isMuted ? 'Muted' : 'Active'}
              ${participant.isSpeaking ? ' • Speaking' : ''}
            </div>
          </div>
          <div class="status-indicator ${participant.isSpeaking ? 'speaking' : ''} ${participant.isMuted ? 'muted' : ''}"></div>
        </div>
        ${adminControls}
      `;

      return participantDiv;
    }

    function adminMuteUser(socketId) {
      console.log('[v0] Admin muting user:', socketId);
      socket.emit('admin-mute-user', { socketId });
      playSound('click');
    }

    function adminRemoveUser(socketId) {
      console.log('[v0] Admin removing user:', socketId);
      if (confirm('Are you sure you want to remove this user?')) {
        socket.emit('admin-remove-user', { socketId });
        playSound('click');
      }
    }

    function muteAllUsers() {
      console.log('[v0] Admin muting all users');
      socket.emit('admin-mute-all');
      playSound('click');
    }

    function unmuteAllUsers() {
      console.log('[v0] Admin unmuting all users');
      socket.emit('admin-unmute-all');
      playSound('click');
    }

    function leaveRoom() {
      if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
      }

      for (let socketId in peerConnections) {
        peerConnections[socketId].close();
      }

      socket.disconnect();

      document.getElementById('chatInterface').classList.add('hidden');
      document.getElementById('joinForm').classList.remove('hidden');
    }

    function updateParticipants(participants) {
      const participantsList = document.getElementById('participantsList');
      participantsList.innerHTML = '';

      if (!Array.isArray(participants)) {
        participants = [participants];
      }

      participants.forEach(participant => {
        const participantDiv = renderParticipant(participant);
        participantsList.appendChild(participantDiv);
      });

      document.getElementById('participantCount').textContent = document.querySelectorAll('.participant').length;
    }

    function removeParticipant(socketId) {
      const participantDiv = document.getElementById(`participant-${socketId}`);
      if (participantDiv) {
        participantDiv.remove();
      }
      document.getElementById('participantCount').textContent = document.querySelectorAll('.participant').length;
    }

    function toggleMute() {
      isMuted = !isMuted;
      console.log('[v0] Toggling mute to:', isMuted);
      
      if (localStream) {
        localStream.getAudioTracks().forEach(track => {
          track.enabled = !isMuted;
          console.log('[v0] Audio track enabled:', track.enabled);
        });
      }

      const muteBtn = document.getElementById('muteBtn');
      const muteIcon = document.getElementById('muteIcon');
      const muteText = document.getElementById('muteText');

      if (isMuted) {
        muteBtn.classList.add('muted');
        muteIcon.innerHTML = '<path d="M3,9H7L12,4V8.27L16.91,13.18C17.65,12.1 18,10.81 18,9.5C18,9.33 18,9.17 17.97,9H19.97C19.99,9.17 20,9.33 20,9.5C20,11.71 19.05,13.73 17.5,15.18L21,18.68L19.59,20.09L4.91,5.41L6.32,4M12,2A3,3 0 0,1 15,5V8.17L12,5.17V2M12,10.83L15,13.83V5A3,3 0 0,0 12,2V10.83Z"/>';
        muteText.textContent = 'Unmute';
        playSound('mute');
      } else {
        muteBtn.classList.remove('muted');
        muteIcon.innerHTML = '<path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>';
        muteText.textContent = 'Mute';
        playSound('unmute');
      }

      socket.emit('toggle-mute', { isMuted });
    }

    function toggleSpeaker() {
      isSpeakerMuted = !isSpeakerMuted;
      console.log('[v0] Toggling speaker to muted:', isSpeakerMuted);
      
      document.querySelectorAll('audio[id^="audio-"]').forEach(audio => {
        audio.muted = isSpeakerMuted;
        console.log('[v0] Set audio element muted:', audio.muted);
      });

      const speakerBtn = document.getElementById('speakerBtn');
      const speakerIcon = document.getElementById('speakerIcon');
      const speakerText = document.getElementById('speakerText');

      if (isSpeakerMuted) {
        speakerBtn.classList.add('muted');
        speakerIcon.innerHTML = '<path d="M12,18C11.11,18 10.26,17.8 9.5,17.45C11.56,16.5 13,14.42 13,12C13,9.58 11.56,7.5 9.5,6.55C10.26,6.2 11.11,6 12,6A6,6 0 0,1 18,12A6,6 0 0,1 12,18M20,8.69V4H15.31L12,0.69L8.69,4H4V8.69L0.69,12L4,15.31V20H8.69L12,23.31L15.31,20H20V15.31L23.31,12L20,8.69Z"/>';
        speakerText.textContent = 'Unmute';
      } else {
        speakerBtn.classList.remove('muted');
        speakerIcon.innerHTML = '<path d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.85 14,18.71V20.77C18.01,19.86 21,16.28 21,12C21,7.72 18.01,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z"/>';
        speakerText.textContent = 'Speaker';
      }

      playSound('click');
    }

    let audioContext = null;

    // Initialize audio context on first user interaction
    document.addEventListener('click', () => {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }, { once: true });

    // Load theme on page load
    document.addEventListener('DOMContentLoaded', loadTheme);
  </script>
</body>
</html>
